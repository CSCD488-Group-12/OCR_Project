<!DOCTYPE html>
<link rel="stylesheet" href="style.css">
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Userpage</title>
</head>

<body>
    <!--- Header -->
    <div class="topnav">
        <a href="/index.html">Home</a>
        <a href="/userpage.html">My Notes</a>
        <a href="#">My Account</a>
        <button type="button" class="btn-login" onclick="logOut()">Log Out</button>
    </div>

    <!--- Main Body-->
    <div class="mainbody">
        <!--- New Note-->
        <div class="new-note">
            <button type="button" class="btn-newnote" id="newnote" onclick="changeUploadForm(), changeButton()">New Note</button>

            <!-- Upload photo box-->
            <div class="upload-form" id="new-note-form">
                <canvas id="imageCanvas" class="hidden"></canvas>
                <canvas id="croppedCanvas" class="hidden"></canvas>
                <br>
                <button id="crop-button" onclick="document.getElementById('fileInput').click()">Upload Photo</button>
                <button id="submitBtn" class="hidden">Submit</button>
                <button id="undoBtn" class="hidden">Undo</button>
                <button id="convert-button" onclick="convertSelections()">Convert File</button>
                <input type="file" id="fileInput" accept="image/*" style="display:none">
            </div>

        </div>

        <div class="recent-notes"></div>
        <div class="collections"></div>
        <div class="all-notes"></div>

    </div>
<!-- Confirmation Modal -->
<div id="confirmationModal" class="modal hidden">
    <div class="modal-content">
        <span id="closeModal" class="close">&times;</span>
        <p>Are you sure you'd like to use this image for the OCR?</p>
        <img id="previewImage" src="" alt="Selected Image" style="max-width: 80%; max-height: 300px; margin: 10px 0;">
        <br>
        <button id="confirmBtn">Confirm</button>
        <button id="cancelBtn">Cancel</button>
    </div>
</div>


<!--here is the HTML for the confirm photo pop-up window-->

<!-- Modal Styles -->
<style>
    .modal {
        display: flex;
        align-items: center;
        justify-content: center;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
    }

    .modal-content {
        background-color: #fefefe;
        padding: 20px;
        border: 1px solid #888;
        border-radius: 5px;
        text-align: center;
    }

    .hidden {
        display: none;
    }

    .close {
        position: absolute;
        top: 10px;
        right: 15px;
        color: #aaa;
        font-size: 24px;
        cursor: pointer;
    }

    .close:hover {
        color: #000;
    }
</style>
<!--end of the confirm photo pop up window-->


    <script>
        const fileInput = document.getElementById("fileInput");
        const imageCanvas = document.getElementById("imageCanvas");
        const croppedCanvas = document.getElementById("croppedCanvas");
        const submitBtn = document.getElementById("submitBtn");
        const undoBtn = document.getElementById("undoBtn");
        const ctx = imageCanvas.getContext("2d");

        const confirmBtn = document.getElementById("confirmBtn"); //THIS CONFIRM BUTTON WILL BE USED TO SEND THE PHOTO TO THE OCR MODEL
        const cancelBtn = document.getElementById("cancelBtn");
        const confirmationModal = document.getElementById("confirmationModal");
        const closeModal = document.getElementById("closeModal");


        let img = new Image();
        let startX, startY, endX, endY;
        let isCropping = false;
        let isCropped = false;
        let originalImageData = null;

        fileInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.onload = () => {
                        imageCanvas.width = img.width;
                        imageCanvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        originalImageData = imageCanvas.toDataURL("image/png");
                        imageCanvas.classList.remove("hidden");
                        submitBtn.classList.remove("hidden");
                        undoBtn.classList.remove("hidden");
                        isCropped = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
//=================================================================================================
        imageCanvas.addEventListener("mousedown", (e) => {
        const rect = imageCanvas.getBoundingClientRect();
        startX = e.clientX - rect.left;
        startY = e.clientY - rect.top;
        isCropping = true;
    });

    imageCanvas.addEventListener("mousemove", (e) => {
        if (isCropping) {
            const rect = imageCanvas.getBoundingClientRect();
            endX = e.clientX - rect.left;
            endY = e.clientY - rect.top;
            ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
            ctx.drawImage(img, 0, 0);
            ctx.strokeStyle = "green";
            ctx.lineWidth = 2;
            ctx.strokeRect(startX, startY, endX - startX, endY - startY);
        }
    });

    imageCanvas.addEventListener("mouseup", () => {
        isCropping = false;
        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);
        const x = Math.min(startX, endX);
        const y = Math.min(startY, endY);

        if (width > 0 && height > 0) {
            // Create cropped image
            const croppedCtx = croppedCanvas.getContext("2d");
            croppedCanvas.width = img.width;  // Set to original size
            croppedCanvas.height = img.height; // Set to original size

            // Draw cropped area scaled to original size
            croppedCtx.drawImage(imageCanvas, x, y, width, height, 0, 0, img.width, img.height);
            croppedCanvas.classList.remove("hidden");
            isCropped = true; // Mark as cropped
        }
    });
//=============================================================================================================
    let selectedImageData = null;

// Handle submit button click
    submitBtn.addEventListener("click", () => {
        if (isCropped) {
            // Save cropped image data for preview
            selectedImageData = croppedCanvas.toDataURL("image/png");
    }   else {
            // Save original image data for preview
            selectedImageData = originalImageData;
        }
        // Show modal with selected image
        const previewImage = document.getElementById("previewImage");
        previewImage.src = selectedImageData;
        document.getElementById("confirmationModal").classList.remove("hidden");
    });
//=====================================================================================================================

    // Handle undo button click
    undoBtn.addEventListener("click", () => {
    ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
    ctx.drawImage(img, 0, 0);
    croppedCanvas.classList.add("hidden");  // Hide the cropped canvas
    croppedCanvas.width = 0;  // Clear cropped canvas
    croppedCanvas.height = 0; // Clear cropped canvas
    isCropped = false;
    });


    confirmBtn.addEventListener("click", () => {
    // Proceed to download the selected image
    downloadImage(selectedImageData, isCropped ? "cropped-image.png" : "original-image.png");
    confirmationModal.classList.add("hidden");
    });

// Handle cancel button click
    cancelBtn.addEventListener("click", () => {
        confirmationModal.classList.add("hidden");
    });

// Handle close (X) button click
   closeModal.addEventListener("click", () => {
        confirmationModal.classList.add("hidden");
    });


    //THIS CURRENTLY DOWNLOADS THE SELECTED PHOTO WHEN CONFIRM IS SELECTED, THIS FUNCTION CAN BE CHANGED TO CALL THE OCR MODEL
    function downloadImage(dataUrl, filename) {
        const link = document.createElement("a");
        link.href = dataUrl;
        link.download = filename;
        link.click();
    }
//=================================================================================================
        function cropSelections() {
            // crop tool should go here but isnt needed i think?????? decide on this later. 
            enableConvertButton();
        }

        function convertSelections() {}

        function logOut() {}

        function changeUploadForm() {
            if (document.getElementById("newnote").textContent == 'New Note') {
                document.getElementById("new-note-form").style.display = "block";
            } else {
                closeUploadForm();
            }
        }

        function closeUploadForm() {
            document.getElementById("new-note-form").style.display = "none";
        }

        function changeButton() {
            if (document.getElementById("newnote").textContent == 'New Note') {
                document.querySelector('#newnote').textContent = 'Cancel';
            } else {
                document.querySelector('#newnote').textContent = 'New Note';
            }
        }

        function disableConvertButton() {
            document.getElementById("convert-button").disabled = "disabled";
        }

        function enableConvertButton() {
            document.getElementById("convert-button").disabled = false;
        }

        disableConvertButton();
    </script>

</body>
</html>