<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>OCR Note Taker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap' rel='stylesheet'>
<!--NEW MICROSOFT STUFF HERE-->
    <script src="https://alcdn.msauth.net/browser/2.38.0/js/msal-browser.min.js"></script>

<!--END OF NEW MICROSOFT STUFF-->
</head>

<body>
    <!-- Navigation Bar -->
    <div class="topnav">
        <a href="index.html" class="logo">OCR Note Taker</a>
        <div class="topnav-right">
            <button type="button" class="btn-login requires-logout" onclick="login()">Log In</button>
            <button type="button" class="btn-login requires-login hidden" onclick="logOut()">Log Out</button>
        </div>
    </div>

    <!-- Hero Section -->
    <!-- Should only be visible when user is not logged in -->
    <div class="homepage-wrapper">
        <div class="hero-section section requires-logout">
            <h1 class="hero-title requires-logout">Capture. Convert. Create.</h1>
            <p class="hero-subtitle requires-logout">Upload and crop your image, then extract text with ease.</p>
            <button type="button" class="btn-hero requires-logout" id="newnote" onclick="changeUploadForm()">New Note</button>
        </div>

        <!-- Upload Form -->
        <div class="upload-form section" id="new-note-form" ondrop="handleDrop(event)" ondragover="handleDragOver(event)">
            <p id="upload-info">Drag and drop an image here or click the upload button</p>
            <div class="image-preview-row">
                <div class="original-image">
                    <label id="uploadedImageLabel" class="hidden">Original Image</label><br>
                    <canvas id="imageCanvas" class="hidden"></canvas>
                </div>
                <div class="cropped-image">
                    <label id="croppedImageLabel" class="hidden">Cropped Image</label><br>
                    <canvas id="croppedCanvas" class="hidden"></canvas>
                </div>
            </div>
            
            <br>
            <button id="crop-button" onclick="document.getElementById('fileInput').click();">Upload Photo</button>
            <button id="undoBtn" class="hidden">Undo</button>
            <button id="submitBtn" class="hidden">Submit</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none">
        </div>

        <!-- Confirmation Window -->
        <div id="confirmationModal" class="modal hidden">
            <div class="modal-content">
                <span id="closeModal" class="close">&times;</span>
                <p>Are you sure you'd like to use this image for OCR?</p>
                <img id="previewImage" src="" alt="Selected Image" style="max-width: 80%; max-height: 300px; margin: 10px 0;">
                
                <div class="combo-box-container requires-login">
                    <label for="categoryComboBox" class="requires-login">Category:</label>
                    <div class="combo-box requires-login">
                        <input type="text" id="categoryComboBoxInput" class = "requires-login" placeholder="Start typing or select..." oninput="filterComboOptions()" onfocus="showComboOptions()" />
                        <ul id="comboBoxOptions" class="combo-options requires-login hidden"></ul>
                    </div>
                </div>
                
                <div id="loadingSpinner" class="hidden">
                    <p>Processing image, please wait...</p>
                    <div class="spinner"></div>
                </div>

            <!-- OCR results -->
                <div id="ocrResult" class="hidden">
                    <p>Extracted Text:</p>
                    <textarea id="ocrTextOutput" class = "editable-area" rows="10"></textarea>
                    <button id="downloadTxtBtn" class="btn-confirm">Download .txt</button>
                    <button id="downloadPdfBtn" class="btn-confirm">Download .pdf</button>
                    <button id="copyToClipboardBtn" class="btn-confirm">Copy to Clipboard</button>
                    <button id="shareBtn" class="btn-confirm">Share</button>

                </div>
                <br>
                <button id="confirmBtn" class="btn-confirm">Confirm</button>
                <button id="cancelBtn" class="btn-cancel">Cancel</button>
            </div>
        </div>
    </div>


    <!-- Recent Notes -->
    <div class="recent-notes section fade-in requires-login hidden">
        <h2 class="recent-notes-label requires-login">Recent Notes</h2>
        <div id = "recentNotesGrid"></div>
    </div>

    <!-- Collections -->
    <div class="collections-section section fade-in requires-login hidden">
        <h2 class="collections-label requires-login">Your Collections</h2>
        <div class="collections-wrapper">
            <button id="newCollectionBtn" class="btn-new-collection requires-login">+ New Collection</button>
            <div id="collectionsGrid" class="collections-grid"></div>
        </div>
    </div>

    <div id="newCollectionModal" class="modal hidden">
        <div class="modal-content">
          <span class="close" onclick="closeNewCollectionModal()">&times;</span>
          <h2>Create New Collection</h2>
          <input type="text" id="newCollectionInput" placeholder="Enter collection name..." />
          <br><br>
          <button class="btn-confirm" onclick="addNewCollection()">Add Collection</button>
          <button class="btn-cancel" onclick="closeNewCollectionModal()">Cancel</button>
        </div>
      </div>

    
    <!-- All Notes and Search -->
    <div class="all-notes section fade-in requires-login hidden">

        <div class="search-and-toggle">
          <label class="all-notes-label requires-login">All Notes</label>
      
          <div class="search-bar">
            <input type="text" placeholder="Search your notes..." id="noteSearch" />
          </div>
      
          <div class="filter-wrapper">
            <button id="filterNotesBtn" class="filter-btn requires-login hidden">
              <img src="assets/filter-list.png" style="filter: invert(1);" alt="Filter" />
            </button>
            <button id="cancelSearchBtn" class="cancel-search-btn hidden">âœ–</button>
      
            <div id="filterDropdown" class="filter-dropdown hidden">
              <label for="filterCategory">Category:</label>
              <select id="filterCategory"></select>
              <label for="filterStartDate">Start Date:</label>
              <input type="date" id="filterStartDate" />
              <label for="filterEndDate">End Date:</label>
              <input type="date" id="filterEndDate" />
              <button id="applyFiltersBtn" class="btn-confirm">Apply</button>
            </div>
          </div>
      
          <div class="view-toggle-group">
            <button id="listViewBtn" class="view-toggle active">
              <img src="assets/menu-burger.png" alt="List View" style="filter: invert(1);"> List
            </button>
            <button id="gridViewBtn" class="view-toggle">
              <img src="assets/apps.png" alt="Grid View" style="filter: invert(1);"> Grid
            </button>
          </div>
        </div>
      
      </div>
      

    <!-- Floating button for logged-in users -->
    <button id="floatingNewNoteBtn" class="floating-newnote requires-login hidden" onclick="changeUploadForm()">+ New Note</button>

    <!-- Open full note -->
    <div id="noteDetailModal" class="modal hidden requires-login">
        <div class="modal-content note-modal-content">
          <span id="closeNoteModal" class="close">&times;</span>
          <img id="noteDetailImage" src="" alt="Note Image" />
          <h2 id="noteDetailTitle"></h2>
          <div class="search-save-row">
            <div class="combo-box-container">
                <label for="noteDetailCategoryInput">Change Category:</label>
                <div class="combo-box">
                    <input type="text" id="noteDetailCategoryInput" placeholder="Start typing or select..." oninput="filterDetailComboOptions()" onfocus="showDetailComboOptions()" />
                    <ul id="detailComboBoxOptions" class="combo-options hidden"></ul>
                </div>
            </div>
            <button class="btn-confirm" onclick="saveCategoryChange()">Save</button>
        </div>
        
        
          <p id="noteDetailText"></p>
          <p id="noteDetailDate" class="note-date"></p>
        </div>
      </div>

      <div id="toast" class="toast hidden">Copied to clipboard!</div>

    <div class="footer">
        Uicons by <a href="https://www.flaticon.com/uicons">Flaticon</a>
    </div>

<!--ACTUAL MICROSOFT STUFF-->
<script>
    const msalConfig = {
        auth: {
            clientId: "8cd1c3ca-756b-4ddc-ad39-f403faf56489",
            authority: "https://ocrmodelusethis.b2clogin.com/ocrmodelusethis.onmicrosoft.com/b2c_1_ocr_note_taker_signin_signup",
            knownAuthorities: ["ocrmodelusethis.b2clogin.com"],
            redirectUri: "https://kind-stone-06683921e.6.azurestaticapps.net/" //CHANGE THIS TO THE REAL AZURE SITE LINK
        }
    };

    const msalInstance = new msal.PublicClientApplication(msalConfig);

    function login() {
        console.log("Login button clicked");
        try {
            msalInstance.loginRedirect();
        } catch (e) {
            console.error("Login redirect error:", e);
        }
    }

    function logOut() {
        msalInstance.logoutRedirect();
    }

    let loggedInUser = null;

    msalInstance.handleRedirectPromise().then((response) => {
        if (response && response.account) {
            loggedInUser = response.account;
            onUserLogin();
        } else {
            const accounts = msalInstance.getAllAccounts();
            if (accounts.length > 0) {
                loggedInUser = accounts[0];
                onUserLogin();
            } else {
                onUserLogout();
            }
        }
    }).catch((err) => {
        console.error("Login error:", err);
        onUserLogout();
    });

    function onUserLogin() {
        console.log("User is logged in:", loggedInUser.username);
        document.querySelectorAll(".requires-login").forEach(el => el.classList.remove("hidden"));
        document.querySelectorAll(".requires-logout").forEach(el => el.classList.add("hidden"));
        document.querySelector('.homepage-wrapper')?.classList.add('logged-in');
        document.getElementById("noteDetailModal").classList.add("hidden");
        
        renderRecentNotes(testNotes);
        renderCollections(allCategories);
        renderAllNotes(allUserNotes);

        window.requestAnimationFrame(() => {
            setupSearchAndFiltering();
        });
    }

    function onUserLogout() {
        console.log("User is not logged in");
        document.querySelectorAll(".requires-login").forEach(el => el.classList.add("hidden"));
        document.querySelectorAll(".requires-logout").forEach(el => el.classList.remove("hidden"));
        document.querySelector('.homepage-wrapper')?.classList.remove('logged-in');
    }
</script>
<!--END OF MICROSOFT STUFF-->


    <script>

        //Testing data
        const testNotes = [
        {
            title: "Intro to Calculus",
            image: "https://picsum.photos/200/300",
            category: "Math",
            preview: "Limits, derivatives, and functions introduction.",
            lastEdited: "Last Edited: Apr 20, 2025"
        },
        {
            title: "World War II Summary",
            image: "https://picsum.photos/200/300",
            category: "History",
            preview: "Lorem ipsum .......",
            lastEdited: "Last Edited: Apr 18, 2025"
        },
        {
            title: "Photosynthesis Notes",
            image: "https://picsum.photos/200/300",
            category: "Biology",
            preview: "Lorem ipsum .......",
            lastEdited: "Last Edited: Apr 15, 2025"
        }
    ];

            const allUserNotes = [
        {
            title: "Algebra Summary",
            image: "https://picsum.photos/200/300",
            category: "Math",
            preview: "This note explains factoring, the quadratic formula, and examples from homework...",
            lastEdited: "Saved on Apr 3, 2025"
        },
        {
            title: "Cold War Timeline",
            image: "https://picsum.photos/200/300",
            category: "History",
            preview: "Outlined events from 1945â€“1991, including Cuban Missile Crisis and Berlin Wall...",
            lastEdited: "Saved on Mar 27, 2025"
        },
        {
            title: "Poetry Analysis",
            image: "https://picsum.photos/200/300",
            category: "English",
            preview: "Discussed metaphors and mood in Robert Frost's work, focusing on 'The Road Not Taken'...",
            lastEdited: "Saved on Mar 14, 2025"
        },
        {
            title: "Intro to Calculus",
            image: "https://picsum.photos/200/300",
            category: "Math",
            preview: "Limits, derivatives, and functions introduction.",
            lastEdited: "Last Edited: Apr 20, 2025"
        },
        {
            title: "World War II Summary",
            image: "https://picsum.photos/200/300",
            category: "History",
            preview: "Lorem ipsum .......",
            lastEdited: "Last Edited: Apr 18, 2025"
        },
        {
            title: "Photosynthesis Notes",
            image: "https://picsum.photos/200/300",
            category: "Biology",
            preview: "Lorem ipsum .......",
            lastEdited: "Last Edited: Apr 15, 2025"
        }
    ];

        // User-made categories population        
        const allCategories = ["Math", "Science", "English", "Personal", "History"];

        // end testing data

        let currentFilters = {
            category: "",
            startDate: null,
            endDate: null,
            searchQuery: ""
        };
        
        function displayDisclaimer() {
            const uploadInfo = document.getElementById("upload-info");
            const uploadedImage = document.getElementById("imageCanvas");
            const newNoteButton = document.getElementById("newnote");
        
            const imageIsVisible = !uploadedImage.classList.contains("hidden");
            const buttonIsCancel = newNoteButton.textContent === "Cancel";
        
            if (!imageIsVisible && buttonIsCancel) {
                uploadInfo.textContent = "Drag and drop an image here or click the upload button";
            } else {
                uploadInfo.textContent = "The OCR works best with a clear image focused on the text. Consider cropping your image for more accurate results.";
            }
        }

        function changeUploadForm() {
            const uploadForm = document.getElementById("new-note-form");
            const heroNewNoteBtn = document.getElementById("newnote");
            const floatingNewNoteBtn = document.getElementById("floatingNewNoteBtn");
        
            const isOpen = uploadForm.style.display === "block";
        
            if (isOpen) {
                uploadForm.style.display = "none";
                uploadForm.classList.remove("expanded");
                heroNewNoteBtn.textContent = "New Note";
                floatingNewNoteBtn.textContent = "+ New Note";
            } else {
                uploadForm.style.display = "block";
                uploadForm.classList.add("expanded");
                heroNewNoteBtn.textContent = "Cancel";
                floatingNewNoteBtn.textContent = "Cancel";
            }
        
            displayDisclaimer();
        }
        
        
        function closeUploadForm() {
            document.getElementById("new-note-form").style.display = "none";
            document.getElementById("newnote").textContent = "New Note";
            document.getElementById("floatingNewNoteBtn").textContent = "+ New Note";
            resetCanvas();
        }

        function convertSelections(dataUrl, filename) {
            if (!selectedImageData) {
                alert("No image selected for conversion!");
                return;
            }

            const link = document.createElement("a");
            link.href = dataUrl;
            link.download = filename;
            link.click();
        }

        function redrawImage() {
            ctx.clearRect(0,0, imageCanvas.width, imageCanvas.height);
            ctx.save();
            ctx.translate(originX, originY);
            ctx.scale(scale, scale);
            ctx.drawImage(img, 0, 0, imageCanvas.width, imageCanvas.height);
            ctx.restore();
            
            if (isCropping) {
                cropperOutline();
            }
        }

        // resets new note box
        function resetCanvas() {
            ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
            imageCanvas.classList.add("hidden");
            submitBtn.classList.add("hidden");
            undoBtn.classList.add("hidden");
            imageLabel.classList.add("hidden");
            croppedLabel.classList.add("hidden");
            img.src = "";
            fileInput.value = "";

            const croppedCtx = croppedCanvas.getContext("2d");
            croppedCtx.clearRect(0,0, croppedCanvas.width, croppedCanvas.height);
            croppedCanvas.classList.add("hidden");
            croppedCanvas.width = 0;
            croppedCanvas.height = 0;
            isCropped = false;
            
        }
        let cropperEnabled = false;

        function enableCropper() {
            if (cropperEnabled) return;
            cropperEnabled = true;

            imageCanvas.addEventListener('mousedown', (e) => {
                if (isCropping) return;
                isCropping = true;
                const rect = imageCanvas.getBoundingClientRect();
                startX = (e.clientX - rect.left) * (imageCanvas.width/rect.width);
                startY = (e.clientY - rect.top) * (imageCanvas.height/rect.height);
            });

            imageCanvas.addEventListener('mousemove', (e) => {
                if (!isCropping) return;
                const rect = imageCanvas.getBoundingClientRect();
                endX = (e.clientX- rect.left) * (imageCanvas.width/rect.width);
                endY = (e.clientY - rect.top) * (imageCanvas.height/rect.height);
                redrawImage();
                cropperOutline();
            });

            imageCanvas.addEventListener('mouseup', () => {
                isCropping = false;

                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                const x = Math.min(startX, endX);
                const y = Math.min(startY, endY);

                if (width > 0 && height > 0) {
                    const croppedCtx = croppedCanvas.getContext("2d");
                    croppedCanvas.width = width;
                    croppedCanvas.height = height;

                    croppedCtx.drawImage(img, x, y, width, height, 0, 0, width, height);
                    croppedCanvas.classList.remove("hidden");
                    isCropped = true;
                }
            });
        }

        function cropperOutline() {
            ctx.strokeStyle = 'green';
            ctx.lineWidth = 2;
            ctx.strokeRect(startX , startY, endX - startX, endY - startY);
        }

            const fileInput = document.getElementById("fileInput");
            const imageCanvas = document.getElementById("imageCanvas");
            const croppedCanvas = document.getElementById("croppedCanvas");
            const imageLabel = document.getElementById("uploadedImageLabel");
            const croppedLabel = document.getElementById("croppedImageLabel");
            const submitBtn = document.getElementById("submitBtn");
            const undoBtn = document.getElementById("undoBtn");
            const ctx = imageCanvas.getContext("2d");

            const confirmBtn = document.getElementById("confirmBtn"); //THIS CONFIRM BUTTON WILL BE USED TO SEND THE PHOTO TO THE OCR MODEL
            const cancelBtn = document.getElementById("cancelBtn");
            const confirmationModal = document.getElementById("confirmationModal");
            const closeModal = document.getElementById("closeModal");

            let img = new Image();
            let startX, startY, endX, endY;
            let isCropping = false;
            let isCropped = false;
            let originalImageData = null;
            let scale = 1;
            let originX = 0;
            let originY = 0;

            fileInput.addEventListener("change", (event) => {
                if (event.target.files[0]) {
                    handleFiles(event.target.files[0]);
                }
            });
            
            function handleDrop(e) {
                e.preventDefault();
                if (e.dataTransfer.files.length > 0) {
                    handleFiles(e.dataTransfer.files[0]);
                }
            }
            
            function handleDragOver(e) {
                e.preventDefault();
            }
            
            function handleFiles(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
            
            img.onload = () => {
                imageCanvas.width = img.naturalWidth;
                imageCanvas.height = img.naturalHeight;
                ctx.drawImage(img, 0, 0);
                imageCanvas.classList.remove("hidden");
                submitBtn.classList.remove("hidden");
                undoBtn.classList.remove("hidden");
                imageLabel.classList.remove("hidden");
                enableCropper();
                displayDisclaimer();
            };
            
        //=============================================================================================================
            let selectedImageData = null;

        // Handle submit button click
            submitBtn.addEventListener("click", () => {
                if (!croppedCanvas.classList.contains("hidden")) {
                    selectedImageData = croppedCanvas.toDataURL("image/png");
                } else {
                    selectedImageData = imageCanvas.toDataURL("image/png");
                }

                previewImage.src = selectedImageData;
                confirmationModal.classList.remove("hidden");
                confirmBtn.classList.remove("hidden");
                cancelBtn.classList.remove("hidden");
            });
        //=====================================================================================================================

            // Handle undo button click
            undoBtn.addEventListener("click", () => {
                ctx.clearRect(0, 0, imageCanvas.width, imageCanvas.height);
                ctx.drawImage(img, 0, 0, imageCanvas.width, imageCanvas.height);
                croppedCanvas.classList.add("hidden");  // Hide the cropped canvas
                croppedCanvas.width = 0;  // Clear cropped canvas
                croppedCanvas.height = 0; // Clear cropped canvas
                isCropped = false;
            });


            confirmBtn.addEventListener("click", () => {
                if (!selectedImageData) {
                    alert("No image selected.");
                    return;
                }
            
                confirmBtn.classList.add("hidden");
                cancelBtn.classList.add("hidden");
                document.getElementById("loadingSpinner").classList.remove("hidden");
                
                const finalCategory = document.getElementById("categoryComboBoxInput").value.trim();
                
                //DB STUFF
                console.log("Note category:", finalCategory); // send this category the database
                //END DB STUFF


                // FUNCTION ENDPOINT
                const functionEndpoint = "https://ocr-notetaker-function-app.azurewebsites.net/api/ocr?code=MgPRdNP8lAvX5yjvUZe4lRsaNNcV_nlC00bWPLFNwmDpAzFu41Op5A==";

                fetch(functionEndpoint, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        image: selectedImageData
                    })
                })
                .then(async response => {
                    const text = await response.text();
                
                    if (!response.ok) {
                        throw new Error(`Server Error (${response.status}): ${text}`);
                    }
                
                    try {
                        return JSON.parse(text); // Handles JSON even if content-type is wrong
                    } catch (err) {
                        throw new Error(`Unexpected response format: ${text}`);
                    }
                })
                .then(data => {
                    document.getElementById("loadingSpinner").classList.add("hidden");
                    document.getElementById("ocrResult").classList.remove("hidden");
                
                    // âœ… This is where the actual lines are
                    const lines = data?.readResults?.flatMap(page =>
                        (page.lines || []).map(line => line.text)
                    ) || [];
                
                    const output = lines.length > 0 ? lines.join("\n") : "No text found.";
                
                    // âœ… Show only extracted text
                    document.getElementById("ocrTextOutput").value = output;
                
                    // âœ… Log just to confirm
                    // console.log("Extracted lines:", lines);
                })

                .catch(err => {
                    document.getElementById("loadingSpinner").classList.add("hidden");
                    document.getElementById("ocrResult").classList.remove("hidden");
                    document.getElementById("ocrTextOutput").value = "Error: " + err.message;
                });
            });


            document.getElementById("shareBtn").addEventListener("click", async () => {
                const text = document.getElementById("ocrTextOutput").value;
            
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: 'OCR Extracted Text',
                            text: text
                        });
                    } catch (err) {
                        console.error("Sharing failed:", err);
                    }
                } else {
                    // Fallback: Copy to clipboard
                    try {
                        await navigator.clipboard.writeText(text);
                        alert("Text copied to clipboard!");
                    } catch (err) {
                        alert("Could not copy text.");
                    }
                }
            });

        // Handle cancel button click
            cancelBtn.addEventListener("click", () => {
                confirmationModal.classList.add("hidden");

                document.getElementById("categoryComboBoxInput").value = "";
                hideComboOptions();
            });

        // Handle close (X) button click
            closeModal.addEventListener("click", () => {
                    confirmationModal.classList.add("hidden");
                    document.getElementById("ocrResult").classList.add("hidden");
                    document.getElementById("ocrTextOutput").textContent = "";
                    confirmBtn.classList.remove("hidden");
                    cancelBtn.classList.remove("hidden");

                    closeUploadForm();
                });
          
        

        function populateComboBoxOptions(categories) {
            const optionsList = document.getElementById("comboBoxOptions");
            optionsList.innerHTML = "";
            categories.forEach(cat => {
                const li = document.createElement("li");
                li.textContent = cat;
                li.addEventListener("click", () => {
                    document.getElementById("categoryComboBoxInput").value = cat;
                    hideComboOptions();
                });
                optionsList.appendChild(li);
            });
        }

        function filterComboOptions() {
            const input = document.getElementById("categoryComboBoxInput").value.toLowerCase();
            const options = document.querySelectorAll("#comboBoxOptions li");
            options.forEach(option => {
                const match = option.textContent.toLowerCase().includes(input);
                option.style.display = match ? "block" : "none";
            });
            showComboOptions();
        }

        function showComboOptions() {
            document.getElementById("comboBoxOptions").classList.add("visible");
            document.getElementById("comboBoxOptions").classList.remove("hidden");
        }

        function hideComboOptions() {
            document.getElementById("comboBoxOptions").classList.remove("visible");
            document.getElementById("comboBoxOptions").classList.add("hidden");
        }

        document.addEventListener("click", function (event) {
            const comboBox = document.querySelector(".combo-box");
            if (!comboBox.contains(event.target)) {
                hideComboOptions();
            }
        });

        populateComboBoxOptions(allCategories);
       

        // Load logged in user's most recent notes
        function renderRecentNotes(notes) {
            const grid = document.getElementById("recentNotesGrid");
            grid.innerHTML = "";
        
            notes.forEach(note => {
                const card = document.createElement("div");
                card.className = "note-card";
                card.innerHTML = `
                    <img src="${note.image}" alt="Note image" />
                    <div class="note-overlay">
                        <p class="note-title">${note.title}</p>
                        <p class="note-date">${note.lastEdited}</p>
                    </div>
                `;
                card.addEventListener("click", () => openNoteDetailModal(note));
                grid.appendChild(card);
            });
        }
        

        let currentlyOpenNote = null;

        function openNoteDetailModal(note) {
            if (!note || !note.image || !note.preview) return;

            currentlyOpenNote = note;

            document.getElementById("noteDetailTitle").textContent = note.title || "Untitled Note";
            document.getElementById("noteDetailText").textContent = note.preview || "Sample note content goes here.";
            document.getElementById("noteDetailDate").textContent = note.date || note.lastEdited || "Unknown date";
            document.getElementById("noteDetailImage").src = note.image || "https://picsum.photos/200/300";
            document.getElementById("noteDetailCategoryInput").value = note.category || "";

            document.getElementById("noteDetailModal").classList.remove("hidden");
        }

        function saveCategoryChange() {
            const newCat = document.getElementById("noteDetailCategoryInput").value.trim();
            if (!newCat || !currentlyOpenNote) return;

            currentlyOpenNote.category = newCat;
            renderAllNotes(allUserNotes);
            document.getElementById("noteDetailModal").classList.add("hidden");

            showToast("Category updated!");
        }

        
        

        //Load logged in user's collections
        function renderCollections(categories) {
            const grid = document.getElementById("collectionsGrid");
            grid.innerHTML = ""; // just clear the grid
        
            categories.forEach(cat => {
                const item = document.createElement("div");
                item.className = "collection-card";
                item.textContent = cat;
        
                item.addEventListener("click", () => {
                    const filterDropdown = document.getElementById("filterDropdown");
                    const filterSelect = document.getElementById("filterCategory");
        
                    filterSelect.value = filterSelect.value === cat ? "" : cat;
        
                    if (filterDropdown) {
                        filterDropdown.classList.remove("hidden");
                        filterDropdown.classList.add("visible");
                    }
        
                    applyFilters();
                });
        
                grid.appendChild(item);
            });
        }
        

        //Load logged in user's entire history of notes (saved to the database)
        let currentView = "list"; // default

        function renderAllNotes(notes) {
            const container = document.querySelector(".all-notes");

            const oldList = container.querySelector(".all-notes-grid") || container.querySelector(".all-notes-list");
            if (oldList) {
                container.removeChild(oldList);
            }

            if (notes.length === 0) {
                const noResults = document.createElement("p");
                noResults.textContent = "No notes found.";
                noResults.style.textAlign = "center";
                noResults.style.color = "#ccc";
                noResults.style.marginTop = "40px";
                noResults.style.fontSize = "1.1rem";
                container.appendChild(noResults);
                return;
            }

            const list = document.createElement("div");
            list.className = currentView === "grid" ? "all-notes-grid" : "all-notes-list";

            notes.forEach(note => {
                const card = document.createElement("div");
                card.className = `note-history-card ${currentView === "grid" ? "grid" : ""}`;

                if (currentView === "grid") {
                    card.innerHTML = `
                        <div class="note-card-grid-image-wrapper">
                            <img src="${note.image || 'https://via.placeholder.com/280x180?text=Note'}" class="note-card-grid-img" />
                            <div class="note-overlay">
                                <p class="note-title">${note.title}</p>
                                <p class="note-category">${note.category || "Uncategorized"}</p>
                                <p class="note-date">${note.lastEdited}</p>
                            </div>
                        </div>
                    `;
                } else {
                    card.innerHTML = `
                        <div class="note-header">
                            <h3>${note.title}</h3>
                            <span class="note-category">${note.category || "Uncategorized"}</span>
                        </div>
                        <p class="note-preview">${note.preview}</p>
                        <p class="note-date">${note.lastEdited}</p>
                    `;
                }

                card.addEventListener("click", () => {
                    openNoteDetailModal(note);
                });

                list.appendChild(card);
            });

            container.appendChild(list);

            const listBtn = document.getElementById("listViewBtn");
            const gridBtn = document.getElementById("gridViewBtn");

            if (listBtn && !listBtn.dataset.listenerAdded) {
                listBtn.addEventListener("click", () => {
                    currentView = "list";
                    listBtn.classList.add("active");
                    gridBtn.classList.remove("active");
                    renderAllNotes(notes);
                });
                listBtn.dataset.listenerAdded = "true";
            }

            if (gridBtn && !gridBtn.dataset.listenerAdded) {
                gridBtn.addEventListener("click", () => {
                    currentView = "grid";
                    gridBtn.classList.add("active");
                    listBtn.classList.remove("active");
                    renderAllNotes(notes);
                });
                gridBtn.dataset.listenerAdded = "true";
            }
        }

 
        document.getElementById("closeNoteModal").addEventListener("click", () => {
            document.getElementById("noteDetailModal").classList.add("hidden");
        });
        

        const copyBtn = document.getElementById("copyToClipboardBtn");
        if (copyBtn) {
            copyBtn.addEventListener("click", async () => {
                const text = document.getElementById("ocrTextOutput").value;

                try {
                    await navigator.clipboard.writeText(text);
                    showToast("Copied to clipboard!");
                } catch (err) {
                    showToast("Failed to copy.", true);
                }
            });
        }
      
        function showToast(message, isError = false) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.style.background = isError ? "#e53935" : "#1db954";
            toast.classList.add("visible");
        
            setTimeout(() => {
            toast.classList.remove("visible");
            }, 2000);
      }

        const floatingBtn = document.getElementById("floatingNewNoteBtn");
        const navbar = document.querySelector(".topnav");
        
        window.addEventListener("scroll", () => {
            const scrollY = window.scrollY;
            const navbarHeight = navbar.offsetHeight;
        
            if (scrollY > navbarHeight + 20) {
            floatingBtn.classList.add("sticky-mode");
            } else {
            floatingBtn.classList.remove("sticky-mode");
            }
        });
        
        function openNewCollectionModal() {
            document.getElementById("newCollectionModal").classList.remove("hidden");
        }
        
        function closeNewCollectionModal() {
            document.getElementById("newCollectionModal").classList.add("hidden");
            document.getElementById("newCollectionInput").value = "";
        }
        
        function addNewCollection() {
            const name = document.getElementById("newCollectionInput").value.trim();
            if (!name) return alert("Please enter a collection name.");
        
            // Add to allCategories (simulating DB save)
            allCategories.push(name);
            renderCollections(allCategories);
            populateSelectOptions("filterCategory", allCategories);
            closeNewCollectionModal();
        }
    
        document.getElementById("newCollectionBtn").addEventListener("click", openNewCollectionModal);


        function populateDetailComboBoxOptions(categories) {
            const optionsList = document.getElementById("detailComboBoxOptions");
            optionsList.innerHTML = "";
            categories.forEach(cat => {
                const li = document.createElement("li");
                li.textContent = cat;
                li.addEventListener("click", () => {
                    document.getElementById("noteDetailCategoryInput").value = cat;
                    hideDetailComboOptions();
                });
                optionsList.appendChild(li);
            });
        }
        
        populateDetailComboBoxOptions(allCategories);

        function filterDetailComboOptions() {
            const input = document.getElementById("noteDetailCategoryInput").value.toLowerCase();
            const options = document.querySelectorAll("#detailComboBoxOptions li");
            options.forEach(option => {
                const match = option.textContent.toLowerCase().includes(input);
                option.style.display = match ? "block" : "none";
            });
            showDetailComboOptions();
        }
        
        function showDetailComboOptions() {
            document.getElementById("detailComboBoxOptions").classList.remove("hidden");
            document.getElementById("detailComboBoxOptions").classList.add("visible");
        }
        
        function hideDetailComboOptions() {
            document.getElementById("detailComboBoxOptions").classList.add("hidden");
            document.getElementById("detailComboBoxOptions").classList.remove("visible");
        }
        
        document.addEventListener("click", function (event) {
            const comboBox = document.querySelector("#noteDetailModal .combo-box");
            if (comboBox && !comboBox.contains(event.target)) {
                hideDetailComboOptions();
            }
        });
        
        // filtering


        function populateSelectOptions(selectId, optionsArray, includeAll = true) {
            const select = document.getElementById(selectId);
            if (!select) return;
        
            select.innerHTML = "";
            if (includeAll) {
                const allOption = document.createElement("option");
                allOption.value = "";
                allOption.textContent = "All";
                select.appendChild(allOption);
            }
        
            optionsArray.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                select.appendChild(option);
            });
        }

        populateSelectOptions("filterCategory", allCategories);

        

        function applyNoteFilters(notes, filters = {}) {
            const now = new Date();
            const { category = "", startDate = null, endDate = null } = filters;
        
            return notes.filter(note => {
                let noteDate = new Date(note.lastEdited?.replace(/(Saved on |Last Edited: )/, "") || "");

                if (isNaN(noteDate)) return false;

        
                const matchesCategory = !category || note.category === category;
                const matchesStart = !startDate || noteDate >= new Date(startDate);
                const matchesEnd = !endDate || noteDate <= new Date(endDate);
        
                return matchesCategory && matchesStart && matchesEnd;
            });
        }
        
        function applyFilters() {
            currentFilters.category = document.getElementById("filterCategory").value;
            currentFilters.startDate = document.getElementById("filterStartDate").value || null;
            currentFilters.endDate = document.getElementById("filterEndDate").value || null;
        
            applyAllFiltersAndSearch();
            document.getElementById("filterDropdown").classList.add("hidden");
        }
        
        function applyAllFiltersAndSearch() {
            const { category, startDate, endDate, searchQuery } = currentFilters;
        
            let filtered = applyNoteFilters(allUserNotes, {
                category,
                startDate,
                endDate
            });
        
            if (searchQuery) {
                filtered = filtered.filter(note =>
                    (note.title || "").toLowerCase().includes(searchQuery) ||
                    (note.preview || "").toLowerCase().includes(searchQuery) ||
                    (note.category || "").toLowerCase().includes(searchQuery)
                );

            }
        
            renderAllNotes(filtered);
        }
        
        
        document.addEventListener("click", (event) => {
            const filterWrapper = document.querySelector(".filter-wrapper");
            const filterDropdown = document.getElementById("filterDropdown");
        
            if (!filterWrapper.contains(event.target)) {
                filterDropdown.classList.add("hidden");
            }
        });
        


        // improved search bar
        function debounce(func, delay = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => func.apply(this, args), delay);
            };
        }

        document.addEventListener("DOMContentLoaded", () => {
            const sections = document.querySelectorAll('.section');
            const observer = new IntersectionObserver(entries => {
              entries.forEach(entry => {
                if (entry.isIntersecting) {
                  entry.target.classList.add('visible');
                  observer.unobserve(entry.target);
                }
              });
            }, { threshold: 0.1 });
          
            sections.forEach(section => observer.observe(section));
          });
          
        function setupSearchAndFiltering() {
            const searchInput = document.getElementById("noteSearch");
            const cancelSearchBtn = document.getElementById("cancelSearchBtn");
            const filterBtn = document.getElementById("filterNotesBtn");
            const filterDropdown = document.getElementById("filterDropdown");
            const applyFiltersBtn = document.getElementById("applyFiltersBtn");
        
            if (!searchInput || !cancelSearchBtn || !filterBtn || !filterDropdown || !applyFiltersBtn) return;
        
            searchInput.addEventListener("input", debounce(function (event) {
                const value = event.target.value.toLowerCase().trim();
                currentFilters.searchQuery = value;
                applyAllFiltersAndSearch();
                
                if (value!== "") {
                    cancelSearchBtn.classList.add("visible");
                    cancelSearchBtn.classList.remove("hidden");
                } else {
                    cancelSearchBtn.classList.remove("visible");
                    cancelSearchBtn.classList.add("hidden");
                }
            }, 250));
        

            cancelSearchBtn.addEventListener("click", () => {
                searchInput.value = "";
                currentFilters.searchQuery = "";
                applyAllFiltersAndSearch();
                cancelSearchBtn.classList.remove("visible");
                cancelSearchBtn.classList.add("hidden");
            });
        
            searchInput.addEventListener("blur", () => {
                if (searchInput.value.trim() === "") {
                    cancelSearchBtn.classList.add("hidden");
                    cancelSearchBtn.classList.remove("visible");
                }
            });
        

            filterBtn.addEventListener("click", (e) => {
                e.stopPropagation();
                filterDropdown.classList.toggle("hidden");
                filterDropdown.classList.toggle("visible");
            });
        

            applyFiltersBtn.addEventListener("click", () => {
                currentFilters.category = document.getElementById("filterCategory").value;
                currentFilters.startDate = document.getElementById("filterStartDate").value || null;
                currentFilters.endDate = document.getElementById("filterEndDate").value || null;
                applyAllFiltersAndSearch();
                filterDropdown.classList.add("hidden");
            });
        
            document.addEventListener("click", (event) => {
                const wrapper = document.querySelector(".filter-wrapper");
                if (!wrapper.contains(event.target)) {
                    filterDropdown.classList.add("hidden");
                    filterDropdown.classList.remove("visible");
                }
            });
        }
        
        
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Download functionality
        // TXT download
        document.getElementById("downloadTxtBtn").addEventListener("click", () => {
            const text = document.getElementById("ocrTextOutput").value;
            const blob = new Blob([text], { type: "text/plain" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "ocr_result.txt";
            link.click();
        });

        // PDF download
        document.getElementById("downloadPdfBtn").addEventListener("click", async () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const text = document.getElementById("ocrTextOutput").value;

            const lines = doc.splitTextToSize(text, 180);
            doc.text(lines, 10, 10);
            doc.save("ocr_result.pdf");
        });
    </script>

  
</body>
</html>
